<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D1 Read Replicas - Cloudflare</title>
    <link rel="stylesheet" href="global.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="logo">
            <img src="cloudflare.svg" alt="Cloudflare">
        </div>
        <div class="auth-buttons">
            <button class="sign-in">Sign In</button>
            <button class="sign-up">Sign Up</button>
        </div>
    </header>

    <main class="main-content">
        <div class="breadcrumb">Introducing</div>
        <h1>D1 Read Replicas</h1>
        <p class="description">
            Watch how quickly writes propagate across our global network of read replicas. 
            Click the button below to perform a write operation and observe the latency across different regions.
        </p>
        
        <div class="controls">
            <button class="write-button" id="writeButton">Perform Write</button>
            <span class="last-write" id="lastWrite"></span>
        </div>

        <table>
            <thead>
                <tr>
                    <th class="title-col">Region</th>
                    <th>Code</th>
                    <th>Mean</th>
                    <th>Median</th>
                    <th>Min</th>
                    <th>Max</th>
                    <th>Latest</th>
                </tr>
            </thead>
            <tbody id="replicaTable">
                <!-- Table rows will be populated by JavaScript -->
            </tbody>
        </table>
    </main>

    <div id="globe-container"></div>
    <script type="module" src="js/main.js"></script>
    <script>
        const API_BASE = 'https://replication-regions.brayden-b8b.workers.dev';
        const writeButton = document.getElementById('writeButton');
        const lastWrite = document.getElementById('lastWrite');
        const replicaTable = document.getElementById('replicaTable');
        let lastWriteTime = null;
        let regionData = {};
        // Add storage for historical latency values
        let latencyHistory = {};

        // Fetch locations data
        async function loadLocations() {
            try {
                const response = await fetch('/locations.json');
                const data = await response.json();
                regionData = data
                // regionData = data.reduce((acc, location) => {
                //     acc[location.region.toUpperCase()] = `${location.city}, ${location.state}, ${location.country}`;
                //     return acc;
                // }, {});
                // console.log('loadLocations: ', data)
            } catch (error) {
                console.error('Error loading locations:', error);
                // Fallback to existing mapping if load fails
                regionData = {
                    'ENAM': 'Ashburn, VA, USA',
                    'WNAM': 'Hillsboro, OR, USA',
                    'WEUR': 'Falkenstein, Germany',
                    'EEUR': 'Helsinki, Finland',
                    'APAC': 'Singapore, Singapore',
                    'OC': 'Sydney, Australia'
                };
            }
        }

        async function fetchReplicas() {
            // try {
            //     const response = await fetch(`${API_BASE}/instance/x1/replicas`, {
            //         mode: 'cors',
            //         headers: {
            //             'Accept': '*/*',
            //             'Content-Type': 'application/json',
            //         },
            //         credentials: 'omit'
            //     });
            //     if (!response.ok) throw new Error('Network response was not ok');
            //     const data = await response.json();
            //     return data.response.response;
            // } catch (error) {
            //     console.error('Error fetching replicas:', error);
            //     // Return mock data for development
            //     return [
            //         {
            //             region: "ENAM",
            //             type: "primary",
            //             id: "mock-id-1"
            //         },
            //         {
            //             region: "ENAM",
            //             type: "replica",
            //             id: "mock-id-2"
            //         },
            //         {
            //             region: "WNAM",
            //             type: "replica",
            //             id: "mock-id-3"
            //         }
            //     ];
            // }
        }

        async function performWrite() {
            writeButton.disabled = true;
            const regions = ['wnam', 'enam', 'weur', 'eeur', 'apac', 'oc'];
            lastWriteTime = new Date();
            lastWrite.textContent = `Last write: ${lastWriteTime.toLocaleTimeString()}`;

            try {
                const requests = regions.map(region => {
                    const startTime = performance.now();
                    return fetch(`${API_BASE}`, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Accept': '*/*',
                            'Content-Type': 'application/json',
                        },
                        credentials: 'omit',
                        body: JSON.stringify({ region })
                    })
                    .then(async response => {
                        const endTime = performance.now();
                        if (!response.ok) throw new Error(`Network response was not ok for ${region}`);
                        const data = await response.json();
                        const latency = Math.round(endTime - startTime);
                        
                        // Store latency in history
                        if (!latencyHistory[data.colo]) {
                            latencyHistory[data.colo] = [];
                        }
                        latencyHistory[data.colo].push(latency);
                        
                        return {
                            region: region.toUpperCase(),
                            latency: latency,
                            colo: data.colo
                        };
                    });
                });

                const results = await Promise.all(requests);
                window.latencyResults = results;
                updateTable();
            } catch (error) {
                console.error('Error performing writes:', error);
            } finally {
                writeButton.disabled = false;
            }
        }

        function calculateStats(latencies) {
            if (!latencies || latencies.length === 0) return { mean: '-', median: '-', min: '-', max: '-' };
            
            const mean = Math.round(latencies.reduce((a, b) => a + b, 0) / latencies.length);
            const sorted = [...latencies].sort((a, b) => a - b);
            const median = Math.round(sorted[Math.floor(sorted.length / 2)]);
            const min = Math.min(...latencies);
            const max = Math.max(...latencies);
            
            return { mean, median, min, max };
        }

        function getLatencyClass(value) {
            if (value === '-') return '';
            if (value < 100) return 'latency-good';
            if (value < 200) return 'latency-medium';
            return 'latency-poor';
        }

        function updateTable() {
            const results = window.latencyResults || [];
            console.log('regionData:', regionData);
            console.log('results:', results);
            replicaTable.innerHTML = results.map(result => {
                const location = regionData.find(loc => loc.iata === result.colo);
                const locationName = location ? `${location.city}, ${location.cca2}, ${location.region}` : result.colo;
                
                const stats = calculateStats(latencyHistory[result.colo]);

                return `
                    <tr>
                        <td class="title-col">${locationName}</td>
                        <td class="region-code">${result.colo}</td>
                        <td class="normal-col ${getLatencyClass(stats.mean)}">${stats.mean} ${stats.mean !== '-' ? 'ms' : ''}</td>
                        <td class="normal-col ${getLatencyClass(stats.median)}">${stats.median} ${stats.median !== '-' ? 'ms' : ''}</td>
                        <td class="normal-col ${getLatencyClass(stats.min)}">${stats.min} ${stats.min !== '-' ? 'ms' : ''}</td>
                        <td class="normal-col ${getLatencyClass(stats.max)}">${stats.max} ${stats.max !== '-' ? 'ms' : ''}</td>
                        <td class="normal-col ${getLatencyClass(result.latency)}">${result.latency} ms</td>
                    </tr>
                `;
            }).join('');
        }

        // Initialize
        loadLocations().then(() => {
            writeButton.addEventListener('click', performWrite);
            updateTable();
            // Update table every 5 seconds
            // setInterval(updateTable, 5000);
        });
    </script>
</body>
</html> 